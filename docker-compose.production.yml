version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: one-api-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: R00tMySQL!2025Dec02
      MYSQL_DATABASE: one_api
      MYSQL_USER: oneapi
      MYSQL_PASSWORD: OneApiSuperPass2025Simple
    volumes:
      - ./mysql-data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "--password=R00tMySQL!2025Dec02"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 10s
    networks:
      - one-api-network

  # Redis for caching and rate limiting (recommended)
  redis:
    image: redis:7-alpine
    container_name: one-api-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - ./redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - one-api-network

  one-api:
    # === CHANGED: Use your custom image with bug fixes & UX improvements ===
    image: ghcr.io/pl68686868-arch/api-one:latest
    container_name: one-api
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "3000:3000"
    environment:
      # Security
      SECRET_KEY: "1198408c24099372e89cf177e7ae32730d5efbd9330ff33bca1bf568934eae6b"
      SESSION_SECRET: "change_this_to_anything_2025"
      
      # Database
      SQL_DSN: "oneapi:OneApiSuperPass2025Simple@tcp(mysql:3306)/one_api?charset=utf8mb4&parseTime=True&loc=Local&timeout=30s"
      
      # Redis (enables caching & optimized rate limiting)
      REDIS_CONN_STRING: "redis://redis:6379"
      
      # Performance settings
      SYNC_FREQUENCY: 60
      BATCH_UPDATE_ENABLED: "true"
      
      # Server settings
      PORT: 3000
      LOG_LEVEL: info
      TZ: Asia/Ho_Chi_Minh
      
      # Registration
      DISABLE_REGISTRATION: "true"
    volumes:
      - ./data:/data
      - ./logs:/app/logs
    command: --log-dir /app/logs
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:3000/api/status | grep -q 'success'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - one-api-network

networks:
  one-api-network:
    driver: bridge
